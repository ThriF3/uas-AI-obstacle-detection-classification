<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Obstacle Detection System</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
    <!-- Full Screen Video Container -->
    <div class="fixed-container">
        <!-- Video Feed -->
        <video id="video" autoplay playsinline muted class="video-fullscreen"></video>

        <!-- Inactive State Overlay -->
        <div class="inactive-overlay" id="inactiveOverlay">
            <svg class="icon-xl" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round"
                    d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
            </svg>
            <p class="text-gray-lg mb-8">Camera not active</p>
            <button id="startBtnMain" class="btn-primary-lg">
                <svg class="icon-md" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                Start Camera
            </button>
        </div>

        <!-- Status Bar - Top -->
        <div class="status-bar" id="statusBar">
            <div class="status-content">
                <div class="status-left">
                    <div class="status-dot" id="statusDot"></div>
                    <span class="status-text" id="statusText">Inactive</span>
                </div>
                <svg class="icon-sm text-blue" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
            </div>
        </div>

        <!-- Error Message -->
        <div class="error-alert hidden" id="errorMessage">
            <p class="error-text"></p>
        </div>

        <!-- Detection Results Overlay -->
        <div class="results-overlay hidden" id="resultsOverlay">
            <div class="results-card">
                <!-- Main Detection -->
                <div class="detection-main">
                    <div class="detection-header">
                        <span class="detection-label">DETECTED</span>
                        <span class="live-badge">Live</span>
                    </div>
                    <h3 class="detection-class" id="detectedClass">-</h3>
                    <div class="confidence-container">
                        <div class="confidence-header">
                            <span class="confidence-label">Confidence</span>
                            <span class="confidence-value" id="confidenceValue">0%</span>
                        </div>
                        <div class="progress-bar-main">
                            <div class="progress-fill-gradient" id="confidenceBar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <!-- Top 3 Probabilities -->
                <div class="probabilities-list" id="probabilitiesList"></div>
            </div>
        </div>

        <!-- Control Button - Bottom -->
        <div class="control-bottom hidden" id="controlBottom">
            <button id="stopBtn" class="btn-danger-lg">
                <svg class="icon-sm" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
                </svg>
                Stop Camera
            </button>
        </div>
    </div>

    <!-- Hidden canvas for frame capture -->
    <canvas id="canvas" class="hidden"></canvas>

    <script>
        let video = document.getElementById('video');
        let canvas = document.getElementById('canvas');
        let ctx = canvas.getContext('2d');
        let stream = null;
        let processingInterval = null;
        let isProcessing = false;

        const inactiveOverlay = document.getElementById('inactiveOverlay');
        const statusBar = document.getElementById('statusBar');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const errorMessage = document.getElementById('errorMessage');
        const resultsOverlay = document.getElementById('resultsOverlay');
        const controlBottom = document.getElementById('controlBottom');
        const startBtnMain = document.getElementById('startBtnMain');
        const stopBtn = document.getElementById('stopBtn');

        function updateStatus(status) {
            statusDot.className = 'status-dot status-' + status;
            const statusMap = {
                'inactive': 'Inactive',
                'active': 'Active',
                'error': 'Error'
            };
            statusText.textContent = statusMap[status];
        }

        // Start camera
        startBtnMain.addEventListener('click', async () => {
            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: 'environment'
                    }
                });

                video.srcObject = stream;

                // Hide inactive overlay, show controls
                inactiveOverlay.classList.add('hidden');
                statusBar.classList.remove('hidden');
                controlBottom.classList.remove('hidden');

                updateStatus('active');
                errorMessage.classList.add('hidden');

                // Start processing frames
                processingInterval = setInterval(processFrame, 1000);
            } catch (error) {
                console.error('Error accessing camera:', error);
                updateStatus('error');
                errorMessage.querySelector('.error-text').textContent = 'Camera access denied or unavailable';
                errorMessage.classList.remove('hidden');
                statusBar.classList.remove('hidden');
            }
        });

        // Stop camera
        stopBtn.addEventListener('click', () => {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }

            if (processingInterval) {
                clearInterval(processingInterval);
            }

            // Show inactive overlay, hide controls
            inactiveOverlay.classList.remove('hidden');
            statusBar.classList.add('hidden');
            controlBottom.classList.add('hidden');
            resultsOverlay.classList.add('hidden');

            updateStatus('inactive');
        });

        // Process frame and send to backend
        async function processFrame() {
            if (isProcessing) return;

            isProcessing = true;

            try {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0);

                const imageData = canvas.toDataURL('image/jpeg', 0.8);

                const response = await fetch('/predict', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ image: imageData })
                });

                const data = await response.json();

                if (data.success) {
                    updateResults(data);
                } else {
                    console.error('Prediction error:', data.error);
                }
            } catch (error) {
                console.error('Processing error:', error);
            } finally {
                isProcessing = false;
            }
        }

        // Update UI with results
        function updateResults(data) {
            resultsOverlay.classList.remove('hidden');

            document.getElementById('detectedClass').textContent = data.predicted_class;

            const confidencePercent = (data.confidence * 100).toFixed(1);
            document.getElementById('confidenceValue').textContent = confidencePercent + '%';
            document.getElementById('confidenceBar').style.width = confidencePercent + '%';

            // Update top 3 probabilities
            const probList = document.getElementById('probabilitiesList');
            probList.innerHTML = '';

            const sortedProbs = Object.entries(data.probabilities).sort((a, b) => b[1] - a[1]).slice(0, 3);

            sortedProbs.forEach(([className, probability]) => {
                const probPercent = (probability * 100).toFixed(0);
                const isActive = className === data.predicted_class;

                const probItem = document.createElement('div');
                probItem.className = 'prob-item';
                probItem.innerHTML = `
                    <span class="prob-name">${className}</span>
                    <div class="prob-bar-container">
                        <div class="prob-bar ${isActive ? 'prob-bar-active' : 'prob-bar-inactive'}" style="width: ${probPercent}%"></div>
                    </div>
                    <span class="prob-value">${probPercent}%</span>
                `;
                probList.appendChild(probItem);
            });
        }
    </script>
</body>

</html>