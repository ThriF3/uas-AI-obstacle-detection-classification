<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Obstacle Detection System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/4.0.0-alpha.3/base.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        :root {
            --color-slate-600: oklch(.446 .043 257.281);
            --color-slate-700: oklch(.372 .044 257.287);
            --color-slate-800: oklch(.279 .041 260.031);
            --color-slate-900: oklch(.208 .042 265.755);
            --color-blue-400: oklch(.707 .165 254.624);
            --color-blue-500: oklch(.623 .214 259.815);
            --color-blue-600: oklch(.546 .245 262.881);
            --color-blue-700: oklch(.488 .243 264.376);
            --color-purple-500: oklch(.627 .265 303.9);
            --color-gray-300: oklch(.872 .01 258.338);
            --color-gray-400: oklch(.707 .022 261.325);
            --color-gray-500: oklch(.551 .027 264.364);
            --color-gray-600: oklch(.446 .03 256.802);
            --color-red-300: oklch(.808 .114 19.571);
            --color-red-600: oklch(.577 .245 27.325);
            --color-red-700: oklch(.505 .213 27.518);
            --color-red-900: oklch(.396 .141 25.723);
            --color-green-500: oklch(.723 .219 149.579);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, var(--color-slate-900), var(--color-slate-800), var(--color-slate-900));
            color: white;
            min-height: 100vh;
            padding: 1rem;
        }

        .container {
            max-width: 72rem;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .header-title {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .header-title h1 {
            font-size: 2.25rem;
            font-weight: 700;
        }

        .header-subtitle {
            color: var(--color-gray-400);
        }

        .status-bar {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .status-dot {
            width: 0.75rem;
            height: 0.75rem;
            border-radius: 9999px;
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        .status-dot.inactive {
            background-color: var(--color-gray-400);
        }

        .status-dot.active {
            background-color: var(--color-green-500);
        }

        .status-dot.error {
            background-color: var(--color-red-600);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .grid {
            display: grid;
            gap: 1.5rem;
        }

        @media (min-width: 1024px) {
            .grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 768px) {
            body {
                padding: 2rem;
            }
        }

        .card {
            background-color: var(--color-slate-800);
            border-radius: 0.75rem;
            overflow: hidden;
            border: 1px solid var(--color-slate-700);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .card-header {
            background-color: var(--color-slate-700);
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--color-slate-600);
        }

        .card-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-body {
            padding: 1.5rem;
        }

        .video-container {
            position: relative;
            background-color: black;
            border-radius: 0.5rem;
            overflow: hidden;
            margin-bottom: 1rem;
            aspect-ratio: 16 / 9;
        }

        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .video-overlay {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--color-slate-900);
            flex-direction: column;
            gap: 0.75rem;
        }

        .video-overlay.hidden {
            display: none;
        }

        .icon {
            width: 1.25rem;
            height: 1.25rem;
        }

        .icon-lg {
            width: 4rem;
            height: 4rem;
            color: var(--color-gray-600);
        }

        .error-message {
            margin-bottom: 1rem;
            padding: 0.75rem;
            background-color: rgba(127, 29, 29, 0.3);
            border: 1px solid var(--color-red-700);
            border-radius: 0.5rem;
            color: var(--color-red-300);
            font-size: 0.875rem;
        }

        .button-group {
            display: flex;
            gap: 0.75rem;
        }

        .btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 500;
            border: none;
            cursor: pointer;
            transition: background-color 0.15s;
        }

        .btn-primary {
            background-color: var(--color-blue-600);
        }

        .btn-primary:hover:not(:disabled) {
            background-color: var(--color-blue-700);
        }

        .btn-danger {
            background-color: var(--color-red-600);
        }

        .btn-danger:hover:not(:disabled) {
            background-color: var(--color-red-700);
        }

        .btn:disabled {
            background-color: var(--color-slate-600);
            cursor: not-allowed;
        }

        .info-box {
            margin-top: 1rem;
            padding: 0.75rem;
            background-color: rgba(51, 65, 85, 0.5);
            border-radius: 0.5rem;
        }

        .info-box p {
            font-size: 0.75rem;
            color: var(--color-gray-400);
            line-height: 1.5;
        }

        .detection-main {
            margin-bottom: 1.5rem;
            padding: 1.25rem;
            background: linear-gradient(135deg, rgba(30, 58, 138, 0.4), rgba(88, 28, 135, 0.4));
            border-radius: 0.5rem;
            border: 1px solid rgba(29, 78, 216, 0.5);
        }

        .detection-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .detection-label {
            font-size: 0.875rem;
            color: var(--color-gray-400);
        }

        .badge {
            font-size: 0.75rem;
            background-color: var(--color-blue-600);
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
        }

        .detection-class {
            font-size: 1.875rem;
            font-weight: 700;
            margin-bottom: 0.75rem;
        }

        .confidence-bar-container {
            margin-bottom: 0.5rem;
        }

        .confidence-header {
            display: flex;
            justify-content: space-between;
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
        }

        .confidence-header .value {
            font-weight: 600;
        }

        .progress-bar {
            width: 100%;
            height: 0.75rem;
            background-color: var(--color-slate-700);
            border-radius: 9999px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--color-blue-500), var(--color-purple-500));
            border-radius: 9999px;
            transition: width 0.5s;
        }

        .section-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--color-gray-400);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.75rem;
        }

        .probability-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .probability-item {
            background-color: rgba(51, 65, 85, 0.5);
            padding: 0.75rem;
            border-radius: 0.5rem;
        }

        .probability-header {
            display: flex;
            justify-content: space-between;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }

        .probability-header .name {
            color: white;
        }

        .probability-header .name.active {
            font-weight: 600;
            color: var(--color-blue-300);
        }

        .probability-header .value {
            color: var(--color-gray-400);
        }

        .progress-bar-small {
            width: 100%;
            height: 0.5rem;
            background-color: var(--color-slate-800);
            border-radius: 9999px;
            overflow: hidden;
        }

        .progress-fill-small {
            height: 100%;
            border-radius: 9999px;
            transition: width 0.5s;
        }

        .progress-fill-small.active {
            background: linear-gradient(90deg, var(--color-blue-500), var(--color-purple-500));
        }

        .progress-fill-small.inactive {
            background-color: var(--color-slate-600);
        }

        .empty-state {
            text-align: center;
            padding: 4rem 0;
        }

        .empty-state p {
            color: var(--color-gray-500);
        }

        .instructions {
            margin-top: 2rem;
            background-color: var(--color-slate-800);
            border-radius: 0.75rem;
            padding: 1.5rem;
            border: 1px solid var(--color-slate-700);
        }

        .instructions h3 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
        }

        .instructions ol {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            color: var(--color-gray-300);
        }

        .instructions li {
            display: flex;
            gap: 0.75rem;
        }

        .instructions .step-number {
            color: var(--color-blue-400);
            font-weight: 600;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-title">
                <svg class="icon-lg" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                </svg>
                <h1>Obstacle Detection System</h1>
            </div>
            <p class="header-subtitle">Real-time object detection using computer vision</p>
        </div>

        <!-- Status Indicator -->
        <div class="status-bar">
            <div class="status-dot inactive" id="statusDot"></div>
            <span id="statusText">Status: Inactive</span>
        </div>

        <div class="grid">
            <!-- Camera Section -->
            <div class="card">
                <div class="card-header">
                    <h2>
                        <svg class="icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                        Camera Feed
                    </h2>
                </div>
                <div class="card-body">
                    <!-- Video Preview -->
                    <div class="video-container">
                        <video id="video" autoplay playsinline muted></video>
                        <div class="video-overlay" id="videoOverlay">
                            <svg class="icon-lg" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"/>
                            </svg>
                            <p style="color: var(--color-gray-500);">Camera not active</p>
                        </div>
                    </div>

                    <!-- Error Message -->
                    <div class="error-message hidden" id="errorMessage"></div>

                    <!-- Control Buttons -->
                    <div class="button-group">
                        <button class="btn btn-primary" id="startBtn">
                            <svg class="icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
                            </svg>
                            Start Camera
                        </button>
                        <button class="btn btn-danger" id="stopBtn" disabled>
                            <svg class="icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"/>
                            </svg>
                            Stop Camera
                        </button>
                    </div>

                    <!-- Settings Info -->
                    <div class="info-box">
                        <p>
                            <strong>Processing Rate:</strong> 1 frame per second<br>
                            <strong>Image Quality:</strong> 80% JPEG compression
                        </p>
                    </div>
                </div>
            </div>

            <!-- Results Section -->
            <div class="card">
                <div class="card-header">
                    <h2>
                        <svg class="icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                        </svg>
                        Detection Results
                    </h2>
                </div>
                <div class="card-body">
                    <!-- Empty State -->
                    <div class="empty-state" id="emptyState">
                        <svg class="icon-lg" style="margin: 0 auto 1rem;" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                        </svg>
                        <p id="emptyStateText">Start the camera to begin detection</p>
                    </div>

                    <!-- Results Container -->
                    <div class="hidden" id="resultsContainer">
                        <!-- Main Detection -->
                        <div class="detection-main">
                            <div class="detection-header">
                                <span class="detection-label">Detected Obstacle</span>
                                <span class="badge">Primary</span>
                            </div>
                            <h3 class="detection-class" id="detectedClass">-</h3>
                            <div class="confidence-bar-container">
                                <div class="confidence-header">
                                    <span>Confidence</span>
                                    <span class="value" id="confidence">0%</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" id="confidenceBar" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>

                        <!-- All Probabilities -->
                        <div>
                            <h4 class="section-title">All Class Probabilities</h4>
                            <div class="probability-list" id="probabilityList"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Instructions -->
        <div class="instructions">
            <h3>How to Use</h3>
            <ol>
                <li>
                    <span class="step-number">1.</span>
                    <span>Click "Start Camera" to activate your webcam or phone camera</span>
                </li>
                <li>
                    <span class="step-number">2.</span>
                    <span>Point the camera at objects to detect obstacles in real-time</span>
                </li>
                <li>
                    <span class="step-number">3.</span>
                    <span>Detection results update automatically every second</span>
                </li>
                <li>
                    <span class="step-number">4.</span>
                    <span>Click "Stop Camera" when finished to deactivate the camera</span>
                </li>
            </ol>
        </div>
    </div>

    <!-- Hidden canvas for frame capture -->
    <canvas id="canvas" class="hidden"></canvas>

    <script>
        let video = document.getElementById('video');
        let canvas = document.getElementById('canvas');
        let ctx = canvas.getContext('2d');
        let stream = null;
        let processingInterval = null;
        let isProcessing = false;

        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const videoOverlay = document.getElementById('videoOverlay');
        const errorMessage = document.getElementById('errorMessage');
        const emptyState = document.getElementById('emptyState');
        const emptyStateText = document.getElementById('emptyStateText');
        const resultsContainer = document.getElementById('resultsContainer');

        function updateStatus(status) {
            statusDot.className = 'status-dot ' + status;
            const statusMap = {
                'inactive': 'Inactive',
                'active': 'Active',
                'error': 'Error'
            };
            statusText.textContent = 'Status: ' + statusMap[status];
        }

        // Start camera
        startBtn.addEventListener('click', async () => {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: 'environment'
                    } 
                });
                
                video.srcObject = stream;
                videoOverlay.classList.add('hidden');
                
                startBtn.disabled = true;
                stopBtn.disabled = false;
                
                updateStatus('active');
                errorMessage.classList.add('hidden');
                
                emptyStateText.textContent = 'Processing frames...';
                
                // Start processing frames
                processingInterval = setInterval(processFrame, 1000);
            } catch (error) {
                console.error('Error accessing camera:', error);
                updateStatus('error');
                errorMessage.textContent = 'Camera access denied or unavailable';
                errorMessage.classList.remove('hidden');
            }
        });

        // Stop camera
        stopBtn.addEventListener('click', () => {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }
            
            if (processingInterval) {
                clearInterval(processingInterval);
            }
            
            videoOverlay.classList.remove('hidden');
            startBtn.disabled = false;
            stopBtn.disabled = true;
            
            updateStatus('inactive');
            emptyState.classList.remove('hidden');
            resultsContainer.classList.add('hidden');
            emptyStateText.textContent = 'Start the camera to begin detection';
        });

        // Process frame and send to backend
        async function processFrame() {
            if (isProcessing) return;
            
            isProcessing = true;
            
            try {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0);
                
                const imageData = canvas.toDataURL('image/jpeg', 0.8);
                
                const response = await fetch('/predict', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ image: imageData })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    updateResults(data);
                } else {
                    console.error('Prediction error:', data.error);
                }
            } catch (error) {
                console.error('Processing error:', error);
            } finally {
                isProcessing = false;
            }
        }

        // Update UI with results
        function updateResults(data) {
            emptyState.classList.add('hidden');
            resultsContainer.classList.remove('hidden');
            
            document.getElementById('detectedClass').textContent = data.predicted_class;
            
            const confidencePercent = (data.confidence * 100).toFixed(1);
            document.getElementById('confidence').textContent = confidencePercent + '%';
            document.getElementById('confidenceBar').style.width = confidencePercent + '%';
            
            // Update probabilities
            const probList = document.getElementById('probabilityList');
            probList.innerHTML = '';
            
            const sortedProbs = Object.entries(data.probabilities).sort((a, b) => b[1] - a[1]);
            
            sortedProbs.forEach(([className, probability]) => {
                const probPercent = (probability * 100).toFixed(1);
                const isActive = className === data.predicted_class;
                
                const probItem = document.createElement('div');
                probItem.className = 'probability-item';
                probItem.innerHTML = `
                    <div class="probability-header">
                        <span class="name ${isActive ? 'active' : ''}">${className}</span>
                        <span class="value">${probPercent}%</span>
                    </div>
                    <div class="progress-bar-small">
                        <div class="progress-fill-small ${isActive ? 'active' : 'inactive'}" style="width: ${probPercent}%"></div>
                    </div>
                `;
                probList.appendChild(probItem);
            });
        }
    </script>
</body>
</html>